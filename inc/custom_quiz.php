<?php add_action('init', 'quiz_custom_post_types');function quiz_custom_post_types() {	// Product features		$labels = array(			'name' => _x('Quizs', 'post type general name'),			'singular_name' => _x('Quiz', 'post type singular name'),			'add_new' => _x('Add Quiz', 'Support posts'),			'add_new_item' => __('Add New Quiz'),			'edit_item' => __('Edit Quiz'),			'new_item' => __('New Quiz'),			'view_item' => __('View Quiz'),			'search_items' => __('Search Quiz'),			'not_found' =>  __('No Quiz found'),			'not_found_in_trash' => __('No Quiz posts found in Trash'),			'parent_item_colon' => ''		);		register_post_type(			'quiz',			array(				'labels' => $labels,				'public' => true,				'show_ui' => true,				'hierarchical' => true,								'rewrite' => true,				'exclude_from_search' => false,				'show_in_nav_menus' => true,				'supports' => array(					'title',					'editor',					'page-attributes',					//'thumbnail',					//'excerpt',					//'comments',					//'author'				)			)		);					add_shortcode( 'quiz', 'quiz_shortcode' );	add_action('wp_ajax_quiz_register', 'quiz_register_callback');	add_action('wp_ajax_nopriv_quiz_register', 'quiz_register_callback');		add_action('wp_ajax_quiz_send_data', 'quiz_send_data_callback');	add_action('wp_ajax_nopriv_quiz_send_data', 'quiz_send_data_callback');		add_action('wp_ajax_quiz_request_consulation', 'quiz_request_consulation_callback');	add_action('wp_ajax_nopriv_quiz_request_consulation', 'quiz_request_consulation_callback');		}function quiz_request_consulation_callback(){	if ( !wp_verify_nonce( $_REQUEST['nonce'], 'quiz_request_consulation' )) {		echo 'Sequrity error';		exit;	}		$errors = false;	$quiz_id    = (int)$_REQUEST['quiz_id'];	$quiz_email = $_REQUEST['quiz_email'];		if ( !is_email($quiz_email) ){		$errors = true;	}	//echo '<pre>';	//print_r($_REQUEST);	//echo '</pre>';				if($errors === false){		$quiz_key = 'quiz_'.$quiz_id."_".$quiz_email;		$quiz_post = get_post($quiz_id);		$quiz = get_option($quiz_key);					$questions = get_field('questions', $quiz_id);		$results_text = get_field('results_text', $quiz_id);				$suggestion_html = '';				$suggestion_html .= '<h1>Quiz title: '.$quiz_post->post_title.'</h1>';		$suggestion_html .= '<h2>Quiz ID: '.$quiz_post->ID.'</h2>';				$suggestion_html .= '<h3>Date: '.$quiz['quiz_date'].'</h3>';		$suggestion_html .= '<h3>Name: '.$quiz['quiz_name'].'</h3>';		$suggestion_html .= '<h3>Email: '.$quiz['quiz_email'].'</h3>';		$suggestion_html .= '<h3>Totoal Score: '.$quiz['quiz_total'].'</h3>';				$suggestion_html .= '<h3>Suggestion:</h3>';				foreach($results_text as $r){			if($r['start_total'] <= $quiz['quiz_total'] && $quiz['quiz_total'] < $r['end_total'] ){						$suggestion_html .= '<p>'.$r['message'].'</p>';			}		}				$suggestion_html .= '<br><h3>Questions: </h3>';				foreach($questions as $qid=>$q){			$id = $qid+1;			$suggestion_html .= '<p><strong>'.$id.'</strong> '.$q['question'].'</p>';			$suggestion_html .= '<p>Question score: '.$quiz['results'][$qid].'</p>';			if($quiz['results'][$qid] < $q['min_rank']){				$suggestion_html .= '<p><strong>Suggestion</strong></p>';				$suggestion_html .= '<p>'.$q['suggestion_title'].'</p>';				$suggestion_html .= '<p>'.$q['suggestion_text'].'</p>';			}			$suggestion_html .= '<hr>';		}						//echo $suggestion_html;				add_filter( 'wp_mail_content_type', 'set_html_content_type' );				$to = get_field('quiz_email', $quiz_id);		$subject = 'Quiz Result';		$body = $suggestion_html;		wp_mail( $to, $subject, $body );				remove_filter( 'wp_mail_content_type', 'set_html_content_type' );	}	die;}function set_html_content_type() {	return 'text/html';}function quiz_register_callback(){	if ( !wp_verify_nonce( $_REQUEST['nonce'], 'quiz_register' )) {		echo 'Sequrity error';		exit;	}		$errors = false;	$quiz_id    = (int)$_REQUEST['quiz_id'];	$quiz_name  = strip_tags($_REQUEST['quiz_name']);	$quiz_email = $_REQUEST['quiz_email'];	$quiz_ignore_result = $_REQUEST['ignore_result'];		if ( !is_email($quiz_email) ){		$errors = true;	}		//echo '<pre>';	//print_r($_REQUEST);	//echo '</pre>';			if($errors === false){		$quiz_key = 'quiz_'.$quiz_id."_".$quiz_email;		$_SESSION['quiz_key'] = $quiz_key;				$quiz = get_option($quiz_key);		if($quiz && $quiz_ignore_result == 0){			echo 'already';		}else{			$quiz_date = date("d/m/Y");			delete_option( $quiz_key );				add_option( $quiz_key, array('quiz_id'=>$quiz_id, 'quiz_name'=>$quiz_name, 'quiz_email'=>$quiz_email, 'quiz_total'=>0, 'quiz_date'=>$quiz_date));			echo 'success';		}			}		die();}function quiz_send_data_callback(){	if ( !wp_verify_nonce( $_REQUEST['nonce'], 'quiz_send_data' )) {		echo 'Sequrity error';		exit;	}		$errors = false;	$success = false;	$error_message = '';	$quiz_id    = (int)$_REQUEST['quiz_id'];	$quiz_email = $_REQUEST['quiz_email'];		$quiz_step  = (int)$_REQUEST['quiz_step'];	$quiz_score	= (int)$_REQUEST['quiz_score'];		if ( !is_email($quiz_email) ){		$errors = true;		$error_message .= 'Email is wrong';	}		if($errors === false){			$quiz_key = 'quiz_'.$quiz_id."_".$quiz_email;		//$_SESSION['quiz_key'];		$quiz = get_option($quiz_key);		$questions = get_field('questions', $quiz_id);				if(count($questions) > $quiz_step && $quiz_step != 0){			$next_step = $quiz_step+1;		}else{			$next_step = 'result';		}				if($quiz){									$quiz['results'][$quiz_step-1] = $quiz_score;						$sum = 0;			$total = 0;			$num_q = 0;			$suggestion_html = '';			foreach($quiz['results'] as $r){				$sum += $r;				$num_q++;			}			$quiz['quiz_sum'] = $sum;			$total = $sum/$num_q;			$quiz['quiz_num_q'] = $num_q;			$quiz['quiz_total'] = number_format($total, 1);						update_option( $quiz_key, $quiz); 							if($next_step == 'result'){									$results_text = get_field('results_text', $quiz_id);				foreach($results_text as $r){					if($r['start_total'] <= $total && $total < $r['end_total'] ){						$suggestion_html .= '<p>'.$r['message'].'</p>';					}				}								foreach($questions as $qid=>$q){					if($quiz['results'][$qid] < $q['min_rank']){						$suggestion_html .= '<strong>'.$q['suggestion_title'].'</strong>';						$suggestion_html .= '<p>'.$q['suggestion_text'].'</p>';					}				}			}								$success = true;								}else{			$errors = true;			$error_message .= 'No Quiz registration';		}			}			$request_data = array(						'errors' => $errors,						'error_message' => $error_message,						'success' => $success,						'next_step' => $next_step,						'quiz' => $quiz 						);						if($next_step == 'result'){								$request_data['suggestion'] = $suggestion_html;		}		echo json_encode($request_data);				die();}function quiz_shortcode( $atts ) {				$out = '';		$quiz_id = (int)$atts['id'];				if(!empty($quiz_id)){						$quiz = get_post($quiz_id);			if($quiz){						$out .= '<div class="b-quiz bdbox">';				$out .= '<div class="b-quiz__title">							<h3>'.$quiz->post_title.'</h3>						</div>';				$out .= '<div class="b-quiz__text">'.wpautop($quiz->post_content).'</div>';								$out .= '<div class="b-quiz__h-box">';								/* 	REGISTRATION  */						$out .= '<div class="b-quiz__box" step="0">							<form action="#" class="b-quiz__form">								<div class="b-quiz__f-row cf">									<label>NAME</label>									<input type="text" id="quiz_name" name="quiz_name">								</div>								<div class="b-quiz__f-row cf">									<label>EMAIL</label>									<input type="email" id="quiz_email" name="quiz_email">								</div>								<div id="already_message" style="display:none">A someone with your email already did this quiz <a href="" id="quiz_agan">Do it agan!</a> <a href="" id="quiz_show_result">View result</a></div>																<div class="b-quiz__f-submit cf">																		<input type="button" id="quiz_submit" value="HOW DO YOU COMPARE? &gt;">								</div>							</form>						</div>';									/* 	QUESTIONS  */									$questions = get_field('questions', $quiz_id);				if($questions){					foreach($questions as $qid=>$q){					$step = $qid+1;					$next_step = $step+1;											$progres = '';						foreach($questions as $qqid=>$qq){ 							if($qqid+1 <= $step){ $active = ' class="active"'; }else{ $active = ''; }								$progres .= '<li'.$active.'></li>';						}									$out .= '<div class="b-quiz__box" step="'.$step.'" style="display:none">							<h4 class="h4">Rank your business between 0 and 10 for each component (where 10 equals excellent):</h4>							<div class="b-quiz__row">								<div class="b-quiz__date">									<span>question</span>									<strong class="num">'.$step.'</strong>									<span>of '.count($questions).'</span>								</div>								<div class="b-quiz__question">									<p>'.$q['question'].'</p>								</div>								<div class="b-quiz__col-btn">									<div class="b-quiz__score">										<input type="text" id="quiz_score_'.$step.'" style="display:none">										<div class="text" style="display:block">your score</div>									</div>									<a href="#" class="b-quiz__btn-next" step="'.$step.'" next_step="'.$next_step.'">next &gt;</a>								</div>							</div>							<div class="b-quiz__progress-row cf">								<h5 class="h5">Progress</h5>								<ul class="b-quiz__progress">'.$progres.'</ul>							</div>						</div>';																	}				}								/*	RESULTS  */								$out .= '<div class="b-quiz__box" id="results" style="display:none">							<h3 class="h3">Results</h3>							<div class="b-quiz__row">								<div class="b-quiz__date">									<span>total</span>									<strong class="num" id="total"></strong>								</div>								<div class="b-quiz__col-results">									<div id="suggestion">									</div>									<div class="b-quiz__buttons">										<a href="#" class="b-quiz__btn" id="print_quiz">PRINT RESULTS</a>										<a href="#" class="b-quiz__btn yellow" id="request_consulation">REQUEST A CONSULTATION</a>									</div>								</div>							</div>						</div>';										$out .= '<div id="quiz_loader" class="b-quiz__ajax-loader"></div>';						$out .= '</div>';								$out .= '</div>';								$out .= '<script>							var quiz_id = '.$quiz_id.';							var quiz_email = "";							var quiz_name = "";							var ignore_result = 0;														jQuery(document).ready(function(){																				jQuery("#quiz_agan").click(function(){									ignore_result = 1;									jQuery("#quiz_submit").click();									jQuery(".b-quiz__score input").val("");									return false;								});																jQuery("#print_quiz").click(function(){																	jQuery("#header-sticky-wrapper").hide();									jQuery("#footer").hide();									jQuery(".crumbs-box").hide();									jQuery("header").hide();									jQuery(".sidebar-left").hide();									jQuery(".sidebar-right").hide();									jQuery(".post-center > p").hide();									window.print();									return false;								});																jQuery(".b-quiz__score input").change(function(){									var score = jQuery(this).val();									score = parseInt(score);									if(score > 10){ 										jQuery(this).val("10"); 									}else if(score < 0){										jQuery(this).val("0"); 									}else{										jQuery(this).val(score); 									}								});																jQuery("#request_consulation").click(function(){																	var quiz_data = {													action : "quiz_request_consulation",													quiz_id : quiz_id,													quiz_email : quiz_email,													nonce: "'.wp_create_nonce('quiz_request_consulation').'"													}										jQuery.post(ajaxurl, quiz_data, function(quiz_data) {																							alert("DONE");									});									return false;								});																jQuery("#quiz_show_result").click(function(){																																				var quiz_data = {													action : "quiz_send_data",													quiz_id : quiz_id,													quiz_step : 0,													quiz_email : quiz_email,													nonce: "'.wp_create_nonce('quiz_send_data').'"													}																				jQuery.post(ajaxurl, quiz_data, function(quiz_data) {																					//alert(quiz_data.toSource());																						if(quiz_data.errors === true){																					alert(quiz_data.error_message);																		} else if(quiz_data.success === true){																								if(quiz_data.next_step == "result"){																									jQuery("#total").html(quiz_data.quiz.quiz_total);													jQuery("#suggestion").html(quiz_data.suggestion);																										jQuery(".b-quiz__box").hide();													jQuery("#results").show();																								} else {																								var next_step = quiz_data.next_step;												jQuery(".b-quiz__box[step="+step+"]").hide();																								jQuery(".b-quiz__box[step="+next_step+"]").show();												}												}										}, "json");																			return false;																	});																jQuery(".b-quiz__score").mouseenter(function() {									jQuery(this).find("input").show();									jQuery(this).find("input").focus();									jQuery(this).find(".text").hide();								}).mouseleave(function() {									var scope = jQuery(this).find("input").val();									if(scope == ""){										jQuery(this).find("input").hide();										jQuery(this).find(".text").show();									}																									});																jQuery("#quiz_submit").click(function(){																		var errors = false;									quiz_name = jQuery("#quiz_name").val();									quiz_email = jQuery("#quiz_email").val();																		if(quiz_name == ""){										errors = true;										jQuery("#quiz_name").css("border", "solid 1px #f2cc2d");										jQuery("#quiz_name").attr("placeholder", "name is required");									} else {										jQuery("#quiz_name").css("border", "medium none");										jQuery("#quiz_name").attr("placeholder", "");									}																		if(quiz_email == ""){										errors = true;										jQuery("#quiz_email").css("border", "solid 1px #f2cc2d");										jQuery("#quiz_email").attr("placeholder", "email is required");									} else if (!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,4})+$/.test(quiz_email)) {										errors = true;																			jQuery("#quiz_email").css("border", "solid 1px #f2cc2d");										jQuery("#quiz_email").val("");										jQuery("#quiz_email").attr("placeholder", "email is incorrect");																				} else {										jQuery("#quiz_email").css("border", "medium none");										jQuery("#quiz_email").attr("placeholder", "");									}																											if(errors === false){																				jQuery("#quiz_loader").show();										var quiz_data = {													action : "quiz_register",													quiz_id : quiz_id,													quiz_email : quiz_email,													quiz_name : quiz_name,													ignore_result : ignore_result,													nonce: "'.wp_create_nonce('quiz_register').'"													}																				jQuery.post(ajaxurl, quiz_data, function(quiz_register_request) {																					if(quiz_register_request == "success"){												var next_step = 1;												var step = 0;												jQuery(".b-quiz__box[step="+step+"]").hide();												jQuery(".b-quiz__box[step="+next_step+"]").show();											} else if(quiz_register_request == "already"){												jQuery("#already_message").show();											} else {												alert("error");											}											jQuery("#quiz_loader").hide();										});									}								});																jQuery(".b-quiz__btn-next").click(function(){									var next_step = jQuery(this).attr("next_step");									var step = jQuery(this).attr("step");									var score = jQuery("#quiz_score_"+step).val();																											if(score == "" || isNaN(score)){										jQuery("#quiz_score_"+step).val("");										jQuery("#quiz_score_"+step).focus();																				jQuery("#quiz_score_"+step).css("border", "solid 1px #f2cc2d");																											}else{										jQuery("#quiz_score_"+step).css("border", "medium none");											jQuery("#quiz_loader").show();																				var quiz_data = {													action : "quiz_send_data",													quiz_id : quiz_id,													quiz_step : step,													quiz_email : quiz_email,													quiz_score : score,													nonce: "'.wp_create_nonce('quiz_send_data').'"													}																				jQuery.post(ajaxurl, quiz_data, function(quiz_data) {																					//alert(quiz_data.toSource());																						if(quiz_data.errors === true){																					alert(quiz_data.error_message);																		} else if(quiz_data.success === true){																								if(quiz_data.next_step == "result"){																									jQuery("#total").html(quiz_data.quiz.quiz_total);													jQuery("#suggestion").html(quiz_data.suggestion);																										jQuery(".b-quiz__box").hide();													jQuery("#results").show();																								} else {																									var next_step = quiz_data.next_step;																										var score = jQuery("#quiz_score_"+next_step).val();																															if(score == ""){																							jQuery("#quiz_score_"+next_step).css("border", "solid 1px #f2cc2d");																															}else{														jQuery("#quiz_score_"+next_step).css("border", "medium none");														}														jQuery(".b-quiz__box[step="+step+"]").hide();																									jQuery(".b-quiz__box[step="+next_step+"]").show();												}												}											jQuery("#quiz_loader").hide();																					}, "json");																																}																		return false;								});							});							</script>';			}else{				$out .= "wrong quiz";			}		}else{			$out .= "quiz ID is required";		}						return $out;	}//add_action( 'init', 'build_quiz_taxonomies', 0 );     function build_quiz_taxonomies() {   	register_taxonomy( 'quiz-category', 'quiz', 						array(	'hierarchical' => true, 								'label' => 'Quiz Category', 								'query_var' => true, 								'rewrite' => true								) 					); 						register_taxonomy( 'content-type', 'quiz', 						array(	'hierarchical' => true, 								'label' => 'Content Type', 								'query_var' => true, 								'rewrite' => true								) 					);  					} add_filter('manage_edit-quiz_columns', 'quiz_list_columns');function quiz_list_columns($columns) {	if (!$columns['shortcode']) {		$new_columns = array();		foreach($columns as $column_key => $column_val) {			$new_columns[$column_key] = $column_val;			if ($column_key == 'title') {				$new_columns['shortcode'] = 'Shortcode';				//$new_columns['people'] = 'People';				//$new_columns['content_type'] = 'Content Type';			}		}		$columns = $new_columns;	}    return $columns;}add_action('manage_quiz_posts_custom_column', 'quiz_list_columns_value', 10, 2);function quiz_list_columns_value($name, $post_id) {	switch ($name) {		case 'shortcode':            echo '<input type="text" value="[quiz id='.$post_id.']">';  		break;		case 'people':					$people_args = array('post_type'=>'people', 'posts_per_page'=>-1, 'post_status'=>'publish' );					$people_args['meta_query'][] = array(																				'key' => 'related_quizs', 										'value' => '"' . $post_id . '"',										'compare' => 'LIKE'										);										$head = get_field('quiz_head', $post_id);					if(!empty($head)) add_filter('posts_orderby', 'people_orderby_head');								$people_query = new WP_Query( $people_args );					//echo $people_query->request;					if ( $people_query->have_posts() ) {							echo '<div class="people-admin"><ul>';						while ( $people_query->have_posts() ){ $people_query->the_post();														$thmbnail = get_field('thmbnail', get_the_ID());							if(!empty($thmbnail)){								$thmbnail_src = $thmbnail['url'];							}else{								$thmbnail_src = get_template_directory_uri()."/images/anonymous-user.gif";							}																					echo '<li><img src="'.$thmbnail_src.'" alt="'.esc_attr(get_the_title()).'" width="32px">'.get_the_title().'</li>';												}						echo '</ul></div>';					} 					remove_filter('posts_orderby', 'people_orderby_head');					wp_reset_postdata();		break;		case 'content_type':			$content_type = get_the_term_list( $post_id, 'content-type', '', ', ', '' );              echo $content_type;  		break;			}}//add_action( 'restrict_manage_posts', 'quiz_filter_fields' );function quiz_filter_fields() {    global $typenow, $wpdb;	if ($typenow == 'quiz') {		$cats = get_categories('type=quiz&hide_empty=0&hierarchical=0&taxonomy=quiz-category');		if (count($cats) > 0) {?>	<select name="quiz-category">	  <option value="">All Quiz Categories</option>	  <?php foreach($cats as $cat) { $s = ''; if ($_GET['quiz-category'] == $cat->term_id) { $s = ' SELECTED'; } ?>	  <option value="<?php echo $cat->term_id; ?>"<?php echo $s; ?>><?php echo $cat->name; ?></option>	  <?php } ?>	</select><?php		}	}}//add_action( 'request', 'quiz_posts_request' );function quiz_posts_request($request) {	global $pagenow;	if (is_admin() && $pagenow == 'edit.php' && isset($request['post_type']) && $request['post_category'] == 'quiz') {		//$request['order'] = 'desc';		//$request['orderby'] = 'menu_order';		if (strlen($request['quiz-category'])) {			$request['quiz-category'] = get_term($request['quiz-category'],'quiz-category')->slug;		}	}	return $request;}?>